import streamlit as st
import pandas as pd
import random
from collections import defaultdict
import string
from io import BytesIO

# --- åˆæœŸãƒ‡ãƒ¼ã‚¿ ---
if "members_df" not in st.session_state:
    members_list = [
        {"åå‰":"ç¥å¤ª","ãƒ‘ãƒ¼ãƒˆ":"Vo","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ãŠã†ãŸ","ãƒ‘ãƒ¼ãƒˆ":"Vo","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"å¤§è¥¿çœŸç¦","ãƒ‘ãƒ¼ãƒˆ":"Vo","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ç¾å’²","ãƒ‘ãƒ¼ãƒˆ":"Vo","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ä¸­æ‘ç²å¥ˆ","ãƒ‘ãƒ¼ãƒˆ":"Vo","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"nao","ãƒ‘ãƒ¼ãƒˆ":"Vo","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"ãƒãƒŠãƒ","ãƒ‘ãƒ¼ãƒˆ":"Vo","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"ã‹ãªãŸ","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã‚€ã“ã‚€ã“","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"äº•ä¸Šæ¶¼ä¹Ÿ","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã‚Šãª","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"å‘å£å†…å…‰","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ç¶¾æ–—","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"ã“ã†ãŸ","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã¾ã‚†","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"æ —æ—","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã¾ãªã‹","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"ã»ã®","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"çµæ„›","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"å„ªé‡Œ","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã¯ã‚‹ã¨","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"æ¡‘æ‘","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"mizu","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã‚ãŸã¹ã§ã™","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã‚Šã‚‡ã†ã™ã‘","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"å¤§å’Œ","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ä¾‘çŸ¥","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã•ã‹ã„ã‚„","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã‚ã‚“ã©ã†ã‚Šã‚‡ã†ãŒ","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"Mizuki","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"é˜ªæœ¬","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã„ãŸã‚‚ã¡","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"å®å¤ªéƒ","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"çµèœ","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"ã‚„ã£ã™ãƒ¼","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã‚†ã†ãª","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"ã—ã‚“ã®ã™ã‘","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ç²é£›","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ãã—ã‚ã‚„ã¨","ãƒ‘ãƒ¼ãƒˆ":"Key","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"Chisaki","ãƒ‘ãƒ¼ãƒˆ":"Key","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"Perry","ãƒ‘ãƒ¼ãƒˆ":"Key","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã²ã‚‡ã‚Š","ãƒ‘ãƒ¼ãƒˆ":"Key","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"ã¾ã¤ã‚‚ã¨ã“ã†ã","ãƒ‘ãƒ¼ãƒˆ":"Key","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã‚ã„ã¿","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ç‘›éŸ³","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã‚ã¤ã—","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã‚ã‚„ã‹","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"æ­Œé‡å¤©æµ·","ãƒ‘ãƒ¼ãƒˆ":"Key","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ãŠãƒ¼ã„","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"ãŠãã‘ã„ã¨","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ãŒã„","ãƒ‘ãƒ¼ãƒˆ":"Vo","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã‹ã»","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã“ã™ãŒã¯ãª","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ä½è—¤è£•é¦¬","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ãŸã‹ã¤ã","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"è¾»æœ¬ç›´å“‰","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"å¤ç¶¸","ãƒ‘ãƒ¼ãƒˆ":"Key","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"è¥¿ç”°ä½³ç¥","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"æ—è‰å­","ãƒ‘ãƒ¼ãƒˆ":"Key","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã¯ã‚‹ã‚„","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"æŸŠï¼ˆã—ã‚…ã†ï¼‰","ãƒ‘ãƒ¼ãƒˆ":"Dr","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã¿ã‹ã“","ãƒ‘ãƒ¼ãƒˆ":"Vo","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ç¾å’²2","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã‚Šãƒ¼ã¾","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"ã‚Šã‚…ã†ã¸ã„","ãƒ‘ãƒ¼ãƒˆ":"Gt","å­¦å¹´":2,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"æ¿±ç”°ã‚Šã‚‡ã†","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":3,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸­ç´š"},
        {"åå‰":"ã‚‹ãª","ãƒ‘ãƒ¼ãƒˆ":"Key","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"kei","ãƒ‘ãƒ¼ãƒˆ":"Vo","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"},
        {"åå‰":"yuzuki","ãƒ‘ãƒ¼ãƒˆ":"Key","å­¦å¹´":1,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"åˆç´š"},
        {"åå‰":"é«˜åŸ","ãƒ‘ãƒ¼ãƒˆ":"Ba","å­¦å¹´":4,"çµŒé¨“ãƒ¬ãƒ™ãƒ«":"ä¸Šç´š"}
    ]
    st.session_state.members_df = pd.DataFrame(members_list)

# --- åˆæœŸãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ ---
if "selected" not in st.session_state:
    st.session_state.selected = {idx: False for idx in st.session_state.members_df.index}

st.title("ğŸ¸ ãƒãƒ³ãƒ‰ä½œæˆã‚¢ãƒ—ãƒª")

# ===============================================================
# ãƒãƒ³ãƒ‰ä½œæˆé–¢æ•°
# ===============================================================
def create_bands(df, selected):
    selected_members = df[[selected[i] for i in df.index]].copy()
    if selected_members.empty:
        st.warning("å‚åŠ è€…ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“")
        return None

    max_per_band = {"Ba": 2, "Dr": 2}
    parts = defaultdict(list)
    for _, row in selected_members.iterrows():
        parts[row["ãƒ‘ãƒ¼ãƒˆ"]].append(row)

    band_counts = []
    for part_name, members_list in parts.items():
        if part_name in max_per_band:
            band_counts.append((len(members_list) + max_per_band[part_name] - 1) // max_per_band[part_name])
        else:
            band_counts.append(len(members_list))
    num_bands = min(band_counts)
    bands = [defaultdict(list) for _ in range(num_bands)]

    for part_name, members_list in parts.items():
        if part_name in ["Gt", "Ba", "Dr"]:
            high = [m for m in members_list if m["çµŒé¨“ãƒ¬ãƒ™ãƒ«"] == "ä¸Šç´š"]
            mid = [m for m in members_list if m["çµŒé¨“ãƒ¬ãƒ™ãƒ«"] == "ä¸­ç´š"]
            low = [m for m in members_list if m["çµŒé¨“ãƒ¬ãƒ™ãƒ«"] == "åˆç´š"]
            random.shuffle(high); random.shuffle(mid); random.shuffle(low)
            members_sorted = high + mid + low
        else:
            members_sorted = members_list.copy()
            random.shuffle(members_sorted)

        band_idx = 0
        for member in members_sorted:
            attempts = 0
            while attempts < num_bands:
                if part_name in max_per_band and len(bands[band_idx][part_name]) >= max_per_band[part_name]:
                    band_idx = (band_idx + 1) % num_bands
                    attempts += 1
                else:
                    bands[band_idx][part_name].append(member["åå‰"])
                    band_idx = (band_idx + 1) % num_bands
                    break
            else:
                bands[0][part_name].append(member["åå‰"])
    return bands

# ===============================================================
# ãƒãƒ³ãƒ‰ä½œæˆå‡¦ç†ï¼ˆä¸Šéƒ¨ï¼‰
# ===============================================================
if "create_band_trigger" in st.session_state and st.session_state.create_band_trigger:
    bands = create_bands(st.session_state.members_df, st.session_state.selected)
    if bands:
        st.session_state.bands_result = bands
    st.session_state.create_band_trigger = False

# ===============================================================
# çµæœè¡¨ç¤ºï¼ˆä¸Šéƒ¨å›ºå®šï¼‰
# ===============================================================
if "bands_result" in st.session_state and st.session_state.bands_result:
    st.subheader("ğŸ¶ ãƒãƒ³ãƒ‰åˆ†ã‘çµæœ")
    result_df = pd.DataFrame(columns=["Vo", "Gt", "Ba", "Dr", "Key"])
    for i, band in enumerate(st.session_state.bands_result):
        band_label = "Band " + string.ascii_uppercase[i]
        row = {col: ", ".join(band.get(col, ["ï¼ˆç©ºãï¼‰"])) for col in ["Vo", "Gt", "Ba", "Dr", "Key"]}
        result_df.loc[band_label] = row
    st.table(result_df)

    towrite = BytesIO()
    result_df.to_excel(towrite, index=True, sheet_name="Bands", engine="openpyxl")
    towrite.seek(0)
    st.download_button(
        "Excel ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
        data=towrite,
        file_name="bands.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
        key="download_btn"
    )

# ===============================================================
# ä¸¦ã³æ›¿ãˆã¨å‚åŠ è€…ãƒªã‚¹ãƒˆ
# ===============================================================
st.divider()
st.subheader("ğŸ¤ å‚åŠ è€…ãƒªã‚¹ãƒˆ")

# ğŸ”¹ åˆæœŸå€¤ã‚’ã€Œå­¦å¹´é †ã€ã«å¤‰æ›´
sort_option = st.selectbox(
    "ä¸¦ã³æ›¿ãˆ",
    ["ä¸€è¦§", "ãƒ‘ãƒ¼ãƒˆé †", "å­¦å¹´é †", "çµŒé¨“ãƒ¬ãƒ™ãƒ«é †"],
    index=2  # â† ã€Œå­¦å¹´é †ã€ã‚’åˆæœŸé¸æŠ
)

df_display = st.session_state.members_df.copy()
if sort_option == "ãƒ‘ãƒ¼ãƒˆé †":
    df_display = df_display.sort_values(by=["ãƒ‘ãƒ¼ãƒˆ", "åå‰"])
elif sort_option == "å­¦å¹´é †":
    df_display = df_display.sort_values(by=["å­¦å¹´", "åå‰"])
elif sort_option == "çµŒé¨“ãƒ¬ãƒ™ãƒ«é †":
    level_order = {"åˆç´š": 0, "ä¸­ç´š": 1, "ä¸Šç´š": 2}
    df_display["çµŒé¨“å€¤"] = df_display["çµŒé¨“ãƒ¬ãƒ™ãƒ«"].map(level_order)
    df_display = df_display.sort_values(by=["çµŒé¨“å€¤", "åå‰"]).drop(columns=["çµŒé¨“å€¤"])


# ãƒãƒ³ãƒ‰ä½œæˆãƒœã‚¿ãƒ³
if st.button("ğŸµ ãƒãƒ³ãƒ‰ä½œæˆ", key="create_band_btn"):
    st.session_state.create_band_trigger = True

# ğŸ”¹ å­¦å¹´ã”ã¨ã«è¦‹å‡ºã—ã‚’è¡¨ç¤ºï¼ˆè¦‹ã‚„ã™ãï¼‰
if sort_option in ["å­¦å¹´é †", "ãƒ‘ãƒ¼ãƒˆé †", "çµŒé¨“ãƒ¬ãƒ™ãƒ«é †"]:
    if sort_option == "å­¦å¹´é †":
        group_key = "å­¦å¹´"
        group_label = lambda x: f"ğŸ“ {x}å¹´"
    elif sort_option == "ãƒ‘ãƒ¼ãƒˆé †":
        group_key = "ãƒ‘ãƒ¼ãƒˆ"
        group_label = lambda x: f"ğŸ¶ {x}"
    else:  # çµŒé¨“ãƒ¬ãƒ™ãƒ«é †
        group_key = "çµŒé¨“ãƒ¬ãƒ™ãƒ«"
        group_label = lambda x: f"â­ {x}"

    for key_value, group in df_display.groupby(group_key):
        st.markdown(f"#### {group_label(key_value)}")
        cols = st.columns(3)
        for i, (_, row) in enumerate(group.iterrows()):
            col_idx = i % 3
            checkbox_key = f"chk_{row.name}"
            st.session_state.selected[row.name] = cols[col_idx].checkbox(
                f"{row['åå‰']}ï¼ˆ{row['ãƒ‘ãƒ¼ãƒˆ']}ãƒ»{row['å­¦å¹´']}å¹´ãƒ»{row['çµŒé¨“ãƒ¬ãƒ™ãƒ«']}ï¼‰",
                value=st.session_state.selected[row.name],
                key=checkbox_key
            )
else:
    # ä¸€è¦§è¡¨ç¤ºï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãªã—ï¼‰
    cols = st.columns(3)
    for i, (_, row) in enumerate(df_display.iterrows()):
        col_idx = i % 3
        checkbox_key = f"chk_{row.name}"
        st.session_state.selected[row.name] = cols[col_idx].checkbox(
            f"{row['åå‰']}ï¼ˆ{row['ãƒ‘ãƒ¼ãƒˆ']}ãƒ»{row['å­¦å¹´']}å¹´ãƒ»{row['çµŒé¨“ãƒ¬ãƒ™ãƒ«']}ï¼‰",
            value=st.session_state.selected[row.name],
            key=checkbox_key
        )


# ğŸ”¹ å‚åŠ è€…ãƒªã‚¹ãƒˆã®ä¸Šã«é¸æŠäººæ•°ã‚’è¡¨ç¤º
total_selected = sum(st.session_state.selected.values())
st.markdown(f"### âœ… ç¾åœ¨ã®é¸æŠäººæ•°ï¼š{total_selected}äºº")
